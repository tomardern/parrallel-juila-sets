<!DOCTYPE html PUBLIC>
<html>
<head>


<title>Nihilogic : Javascript Fractals</title>

<!-- FROM -->
<!-- http://www.nihilogic.dk/labs/javascript_canvas_fractals/ -->


</head>
<body>



<canvas id="mandelbrot"></canvas>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>


<script type="text/javascript" src="julia.js" ></script>

<script type="text/javascript" src="underscore.min.js" ></script>
<script type="text/javascript" src="parallel.min.js" ></script>


<style>
html, body {
	width: 100%;
	height: 100%;
	position: relative;
}
canvas {
	position: absolute;
	top: 0px;
	left: 0px;
}

.controls {
	position: absolute;
	top: 0px;
	left: 0px;
	background: rgba(117, 117, 117, 0.81);
	padding: 10px;
}


</style>

<script type="text/javascript" src="dat.gui.min.js"></script>
<script type="text/javascript">



$(document).ready(function(){



var Options = function() {
  this.size = 400;
  this.isParallel = false;
  this.parallelCores = 4;
  this.isImage = false;
};



var options = new Options();
var gui = new dat.GUI();

var f1 = gui.addFolder('General Options');
f1.add(options, 'size',0,2000).step(1);
f1.add(options, 'isImage');

var f2 = gui.addFolder('Parallel');
f2.add(options, 'isParallel');
f2.add(options, 'parallelCores',1,20).step(1);

f1.open();
f2.open();






	var canvas = document.getElementById("mandelbrot");
	canvas.width = options.size;
	canvas.height = options.size;
	canvas.style.width = canvas.width+"px";
	canvas.style.height = canvas.height+"px";

	var ctx = canvas.getContext("2d");


	function render() {
		console.log("Rendering ----------------");
		ctx.fillStyle = "#000000";
		ctx.fillRect(0,0,options.size,options.size);

		var data = ctx.getImageData(0,0,options.size,options.size);

		//Data.data is the image data. We are over-writing this data
		cores = $("#cores").val();
		each = ((options.size * options.size) / cores);


		var data1 = ctx.getImageData(0,0,options.size,options.size);

		para = [];

		window.startTime = new Date().getTime();
		for(var j = 0; j < cores; j++){
			var start = (j * each );
			var end = start + each;

			//Parameters to pass
			pass = {start:start,end:end,size:options.size};

			if (options.isParallel) {
				result = julia(pass);
				for(at in result.data){
					data1.data[at] = result.data[at];
				}
				var end = new Date().getTime();
				console.log("Done:", end - window.startTime);
				if (options.isImage) {
					ctx.putImageData(data1,0,0);
				}
			} else {



				r = Parallel.spawn(julia, pass);
				r.me = j;

				// Fetch the remote reference and log the result when it's complete
				r.fetch(function (result) {
					for(at in result.data){
						data1.data[at] = result.data[at];
					}

					if (options.isImage) {
						ctx.putImageData(data1,0,0);
					}

					var end = new Date().getTime();
					console.log("Done:", result.core, end - window.startTime);


				});
			}
		}
	}





	/* --------------------------------------------------
	User Interface Stuff , on clicks etc
	-----------------------------------------------------*/
	function getElementPos(el) {
		var x = -(document.body.scrollLeft+document.documentElement.scrollLeft),
			y = -(document.body.scrollTop+document.documentElement.scrollTop);
		while (el && el.nodeName != "BODY") {
			x += el.offsetLeft;
			y += el.offsetTop;
			el = el.offsetParent;
		}
		return {
			x : x,
			y : y
		}
	}

	canvas.onclick = function(e) {
		var pos = getElementPos(canvas)
		var mx = e.clientX - pos.x;
		var my = e.clientY - pos.y;

		var fx = mx / (w*scale);
		var fy = my / (h*scale);

		vx = xmin + dx*fx;
		vy = ymax - fy*dy;

		zoom *= zoomFactor;

		render();
	}


	$("button").click(function(){


		size = $("#size").val();

		w = h = parseInt(size,10);
		canvas.width = w;
		canvas.height = h;
		canvas.style.width = canvas.width+"px";
		canvas.style.height = canvas.height+"px";
		render();

	});







	function onZoomFactorChange(sel) {
		var opt = sel.options[sel.selectedIndex];
		zoomFactor = parseFloat(opt.value);
	}



	function onAlgorithmChange(sel) {
		algo = sel.options[sel.selectedIndex].value;
		vx = vy = 0;
		zoom = 1;
		render();
	}






});

</script>




<div class="controls">
Image size: <input value="400" id="size">
<br>
Cores: <input id="cores" value="8">
<br>


On-click Zoom factor: <select onchange="onZoomFactorChange(this);">
 <option value="0.1">0.1</option>
 <option value="0.5">0.5</option>
 <option value="1">1 (no zoom)</option>
 <option value="2" selected>2</option>
 <option value="5">5</option>
 <option value="10">10</option>
 <option value="100">100</option>
</select>
<br>
<input type="checkbox" id="parallel" />Parallel
<input type="checkbox" id="image" />Image
<br>
<button value="go" />Go!</button>
</div>

</body>

</html>
