<!DOCTYPE html PUBLIC>
<html>
<head>


<!-- FROM -->
<!-- http://www.nihilogic.dk/labs/javascript_canvas_fractals/ -->
</head>
<body>

<canvas id="mandelbrot"></canvas>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>


<script type="text/javascript" src="julia.js" ></script>
<script type="text/javascript" src="underscore.min.js" ></script>
<script type="text/javascript" src="parallel.min.js" ></script>
<script type="text/javascript" src="dat.gui.min.js"></script>

<script src="socket.io.js"></script>



<script type="text/javascript">



$(document).ready(function(){



	var Options = function() {
	  this.size = 400;
	  this.isImage = true;


	  this.distributedCores = 0;
	  this.computeDistributed = function(){
	  	window.distributed();
	  };


	 this.parallelCores = 1;
	  this.computeLocal = function(){
	  	window.local();
	  };



	};

	/* ----------------------------
	GUI using Dat.Gui
	----------------------------*/
	window.options = new Options();
	var gui = new dat.GUI();

	var f1 = gui.addFolder('Options');
	f1.add(options, 'size',0,2000).step(1);
	f1.add(options, 'isImage');

	var f2 = gui.addFolder('Parallel');
	f2.add(options, 'parallelCores',1,20).step(1);
	f2.add(options, 'computeLocal');

	var f3 = gui.addFolder('Distributed');
	f3.add(options, 'distributedCores').listen()
	f3.add(options, 'computeDistributed');

	f1.open();
	f2.open();
	f3.open();







	/* --------------------------------------------------
	Render by Local means (ParallelCores)
	-----------------------------------------------------*/
	window.local = function() {


		var canvas = document.getElementById("mandelbrot");
		canvas.width = canvas.height = options.size;
		canvas.style.width = canvas.style.height+ "px";

		var ctx = canvas.getContext("2d");

		console.log("Rendering ----------------");
		ctx.fillStyle = "#000000";
		ctx.fillRect(0,0,options.size,options.size);



		//Initially make the image data
		var data = ctx.getImageData(0,0,options.size,options.size);

		each = ((options.size * options.size) / options.parallelCores);

		var data1 = ctx.getImageData(0,0,options.size,options.size);

		para = [];

		window.startTime = new Date().getTime();
		for(var j = 0; j < options.parallelCores; j++){
			var start = (j * each );
			var end = start + each;

			//Parameters to pass
			pass = {
				start:start,
				end:end,
				size:options.size
			};

			r = Parallel.spawn(julia, pass);
			r.me = j;


			// Fetch the remote reference and log the result when it's complete
			r.fetch(function (result) {
				for(at in result.data){
					data1.data[at] = result.data[at];
				}

				if (options.isImage) {
					ctx.putImageData(data1,0,0);
				}


				var end = new Date().getTime();
				console.log("Done:", end - window.startTime);


			});
		}
	}



	var socket = io.connect('http://parrallel-juila-sets.192.168.1.6.xip.io:8080');
	socket.on('connect', function (data) {
		console.log("I've connected");
		socket.emit('register', '', function (data) {
      		console.log("I am:",data); // data will be 'woot'
   		});
	});

	socket.on("connections", function(data){

		console.log("connections",data);
		//Update the distributed cores amount to let the user know whats going on
		window.options.distributedCores = data.total;
	});

	socket.on("compute", function(data){

		console.log("compute",data);

	});




	window.distributed = function(){

		//Firstly, lets send out options to the socket.io server

		imgOpts = {
			size:options.size,
		};

		//Emit to the server
		socket.emit('request', imgOpts);


	};




});

</script>



</body>

</html>
