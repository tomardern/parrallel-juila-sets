<!DOCTYPE html PUBLIC>
<html>
<head>


<!-- FROM -->
<!-- http://www.nihilogic.dk/labs/javascript_canvas_fractals/ -->
</head>
<body>

<canvas id="drawarea"></canvas>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>


<script type="text/javascript" src="julia.js" ></script>
<script type="text/javascript" src="underscore.min.js" ></script>
<script type="text/javascript" src="parallel.min.js" ></script>
<script type="text/javascript" src="dat.gui.min.js"></script>

<script src="socket.io.js"></script>



<script type="text/javascript">



$(document).ready(function(){



	var Options = function() {
	  this.size = 400;
	  this.isImage = true;


	  this.distributedCores = 0;
	  this.distributedID = "";
	  this.computeDistributed = function(){
	  	window.distributed();
	  };


	 this.parallelCores = 1;
	  this.computeLocal = function(){
	  	window.local();
	  };



	};

	/* ----------------------------
	GUI using Dat.Gui
	----------------------------*/
	window.options = new Options();
	var gui = new dat.GUI();

	var f1 = gui.addFolder('Options');
	f1.add(options, 'size',0,2000).step(1);
	f1.add(options, 'isImage');

	var f2 = gui.addFolder('Parallel');
	f2.add(options, 'parallelCores',1,20).step(1);
	f2.add(options, 'computeLocal');

	var f3 = gui.addFolder('Distributed');
	f3.add(options, 'distributedCores').listen();
	f3.add(options, 'distributedID').listen();
	f3.add(options, 'computeDistributed');

	f1.open();
	f2.open();
	f3.open();


	/* ----------------------------
	Initialise Canvas
	----------------------------*/
	window.canvasInit = function(size){

		var canvas = document.getElementById("drawarea");
		var ctx = canvas.getContext("2d");

		canvas.width = canvas.height = size;
		canvas.style.width = canvas.style.height+ "px";
		ctx.fillStyle = "#000000";
		ctx.fillRect(0,0,canvas.width,canvas.height);
		return ctx;
	};



	/* ----------------------------
	Compute/Ren
	----------------------------*/


	/* --------------------------------------------------
	Render by Local means (ParallelCores)
	-----------------------------------------------------*/
	window.local = function() {


		ctx = window.canvasInit(options.size);

		console.log("Computing ----------------");

		//Size of each
		each = ((options.size * options.size) / options.parallelCores);

		var data1 = ctx.getImageData(0,0,options.size,options.size);

		window.startTime = new Date().getTime();
		for(var j = 0; j < options.parallelCores; j++){

			//Parameters to pass
			pass = {
				start: (j * each ),
				end: (j * each ) + each,
				size:options.size,
				num: j
			};

			r = Parallel.spawn(julia, pass);

			// Fetch the remote reference and log the result when it's complete
			r.fetch(function (result) {
				for(at in result.data){
					data1.data[at] = result.data[at];
				}

				if (options.isImage) {
					ctx.putImageData(data1,0,0);
				}

				console.log("Done:", result.num , result.time);

			});
		}
	}



	var socket = io.connect('http://parrallel-juila-sets.192.168.1.6.xip.io:8080');
	socket.on('connect', function (data) {

		//Now we need to register (Todo, can we combine with connect above?)
		socket.emit('register', '', function (data) {
			options.distributedID = data;
   		});
	});

	socket.on("connections", function(data){

		console.log("connections",data);
		//Update the distributed cores amount to let the user know whats going on
		options.distributedCores = data.total;
	});

	/* ----------------------------
	Now been asked to compute, lets go
	----------------------------*/
	socket.on("compute", function(data){

		//If a distributed ID has been set
		if (options.distributedID.length){

			//Find the index within the available list
			//Ok, now we have found the index, we need to work out
			index = data.connections[options.distributedID];

			console.log("compute",data);

			ctx = window.canvasInit(options.size);



		}

	});




	window.distributed = function(){

		//Firstly, lets send out options to the socket.io server

		imgOpts = {
			size:options.size,
		};

		//Emit to the server
		socket.emit('request', imgOpts);


	};




});

</script>



</body>

</html>
