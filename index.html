<!DOCTYPE html PUBLIC>
<html>
<head>


<!-- FROM -->
<!-- http://www.nihilogic.dk/labs/javascript_canvas_fractals/ -->
</head>
<body>



<canvas id="mandelbrot"></canvas>


<script src="socket.io.js"></script>
<script>
  var socket = io.connect('http://localhost:8080');
  socket.on('connect', function (data) {
    console.log("I've connected");
    //socket.emit('my other event', { my: 'data' });
  });


</script>



<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>


<script type="text/javascript" src="julia.js" ></script>
<script type="text/javascript" src="underscore.min.js" ></script>
<script type="text/javascript" src="parallel.min.js" ></script>
<script type="text/javascript" src="dat.gui.min.js"></script>

<style>
html, body {
	width: 100%;
	height: 100%;
	position: relative;
}
canvas {
	position: absolute;
	top: 0px;
	left: 0px;
}

.controls {
	position: absolute;
	top: 0px;
	left: 0px;
	background: rgba(117, 117, 117, 0.81);
	padding: 10px;
}


</style>


<script type="text/javascript">



$(document).ready(function(){



	var Options = function() {
	  this.size = 400;
	  this.isParallel = false;
	  this.parallelCores = 4;
	  this.isImage = true;

	  this.isClient = true; //If its a client
	  this.isServer = true; //Sends out the available connections

	  this.render = function(){
	  	window.render();
	  };
	};

	/* ----------------------------
	GUI using Dat.Gui
	----------------------------*/
	var options = new Options();
	var gui = new dat.GUI();

	var f1 = gui.addFolder('General Options');
	f1.add(options, 'size',0,2000).step(1);
	f1.add(options, 'isImage');

	var f2 = gui.addFolder('Parallel');
	f2.add(options, 'isParallel');
	f2.add(options, 'parallelCores',1,20).step(1);

	var f3 = gui.addFolder('Distributed');
	f3.add(options, 'isClient');
	f3.add(options, 'isServer');
	gui.add(options, 'render');

	f1.open();
	f2.open();
	f3.open();



	window.render = function() {


		var canvas = document.getElementById("mandelbrot");
		canvas.width = canvas.height = options.size;
		canvas.style.width = canvas.style.height+ "px";

		var ctx = canvas.getContext("2d");

		console.log("Rendering ----------------");
		ctx.fillStyle = "#000000";
		ctx.fillRect(0,0,options.size,options.size);



		//Initially make the image data
		var data = ctx.getImageData(0,0,options.size,options.size);

		each = ((options.size * options.size) / options.parallelCores);

		var data1 = ctx.getImageData(0,0,options.size,options.size);

		para = [];

		window.startTime = new Date().getTime();
		for(var j = 0; j < options.parallelCores; j++){
			var start = (j * each );
			var end = start + each;

			//Parameters to pass
			pass = {
				start:start,
				end:end,
				size:options.size
			};

			//If it's parallel on the CPU
			if (!options.isParallel) {
				//Pass parameters to the julia function
				result = julia(pass);

				//Now merge the objects together to get a full object
				for(at in result.data){
					data1.data[at] = result.data[at];
				}

				var end = new Date().getTime();
				console.log("Done:", end - window.startTime);
				if (options.isImage) {
					ctx.putImageData(data1,0,0);
				}
			}

			//
			else {


				r = Parallel.spawn(julia, pass);
				r.me = j;


				// Fetch the remote reference and log the result when it's complete
				r.fetch(function (result) {
					for(at in result.data){
						data1.data[at] = result.data[at];
					}

					if (options.isImage) {
						ctx.putImageData(data1,0,0);
					}



					var end = new Date().getTime();
					console.log("Done:", result.me, end - window.startTime);


				});
			}
		}
	}






});

</script>


</body>

</html>
